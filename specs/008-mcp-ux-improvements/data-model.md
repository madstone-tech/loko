# Data Model: MCP UX Improvements (008)

**Branch**: `008-mcp-ux-improvements`  
**Date**: 2026-02-19

---

## New Entity: `Relationship`

**File**: `internal/core/entities/relationship.go`  
**Stored in**: `src/<system-id>/relationships.toml` (one file per system)

### Fields

| Field | Type | Required | Default | Validation |
|---|---|---|---|---|
| `ID` | `string` | yes | generated | Non-empty; deterministic SHA-256 hash of `source+target+label` (8 hex chars) |
| `Source` | `string` | yes | — | Non-empty; slash-separated element path (e.g., `agwe/api-lambda`) |
| `Target` | `string` | yes | — | Non-empty; slash-separated element path; must differ from Source |
| `Label` | `string` | yes | — | Non-empty; human-readable description |
| `Type` | `string` | no | `"sync"` | One of: `"sync"`, `"async"`, `"event"` |
| `Technology` | `string` | no | `""` | Free text (e.g., `"AWS SDK SQS"`) |
| `Direction` | `string` | no | `"forward"` | One of: `"forward"`, `"bidirectional"` |

### Validation Rules (enforced in `NewRelationship()` constructor)

- `Source` must not be empty
- `Target` must not be empty
- `Source` must not equal `Target` (no self-references)
- `Label` must not be empty
- `Type` must be `"sync"`, `"async"`, or `"event"` (if provided)
- `Direction` must be `"forward"` or `"bidirectional"` (if provided)
- `ID` is generated by the constructor; callers do not set it

### Constructor Signature

```go
// NewRelationship creates a validated Relationship entity.
// ID is generated deterministically from source+target+label.
// Returns error if any required field is missing or invalid.
func NewRelationship(source, target, label string, opts ...RelationshipOption) (*Relationship, error)

// RelationshipOption configures optional Relationship fields.
type RelationshipOption func(*Relationship)

func WithRelType(t string) RelationshipOption
func WithRelTechnology(tech string) RelationshipOption
func WithRelDirection(dir string) RelationshipOption
```

### TOML Representation (`relationships.toml`)

```toml
# C4 Model Relationships
# Generated by loko — do not edit the [[relationships]] section manually

[[relationships]]
id = "a1b2c3d4"
source = "agwe/api-lambda"
target = "agwe/sqs-queue"
label = "Enqueue email job"
type = "async"
technology = "AWS SDK SQS"
direction = "forward"

[[relationships]]
id = "e5f6a7b8"
source = "agwe/worker-lambda"
target = "agwe/ses"
label = "Send email via SES"
type = "sync"
direction = "forward"
```

### File Container Struct

```go
// RelationshipsFile is the top-level TOML structure for relationships.toml.
type RelationshipsFile struct {
    Relationships []Relationship `toml:"relationships" json:"relationships"`
}
```

---

## New Port: `RelationshipRepository`

**File**: `internal/core/usecases/ports.go` (appended)

```go
// RelationshipRepository defines the interface for persisting and querying
// C4 model relationships. Implementations store relationships in
// src/<system-id>/relationships.toml.
type RelationshipRepository interface {
    // LoadRelationships returns all relationships for a system.
    // Returns empty slice (not error) if relationships.toml does not exist yet.
    LoadRelationships(ctx context.Context, projectRoot, systemID string) ([]entities.Relationship, error)

    // SaveRelationships atomically overwrites relationships.toml for a system.
    SaveRelationships(ctx context.Context, projectRoot, systemID string, rels []entities.Relationship) error

    // DeleteElement removes all relationships where source or target matches
    // the given element path. Called on container/component delete.
    DeleteElement(ctx context.Context, projectRoot, systemID, elementPath string) error
}
```

---

## New Adapter: `RelationshipRepository` (filesystem)

**File**: `internal/adapters/filesystem/relationship_repo.go`

| Method | Behaviour |
|---|---|
| `LoadRelationships` | Read `src/<systemID>/relationships.toml`; if file absent, return `[]entities.Relationship{}` (not an error) |
| `SaveRelationships` | Marshal to TOML; write to `<path>.tmp`; `os.Rename` to final path (atomic) |
| `DeleteElement` | Load → filter out entries where `Source == elementPath || Target == elementPath` → SaveRelationships |

---

## New Use Cases

### `CreateRelationship`

**File**: `internal/core/usecases/create_relationship.go`

**Input**:
```go
type CreateRelationshipRequest struct {
    ProjectRoot string
    SystemID    string  // slugified system name
    Source      string  // element path
    Target      string  // element path
    Label       string
    Type        string  // optional
    Technology  string  // optional
    Direction   string  // optional
}
```

**Behaviour**:
1. Call `NewRelationship(source, target, label, ...)` — validates and generates ID
2. Load existing relationships via `RelationshipRepository.LoadRelationships`
3. Check for duplicate (same ID) — return existing without error (idempotent)
4. Append new relationship and call `SaveRelationships`
5. Update D2 diagram: determine target diagram file (system.d2 or container.d2), regenerate edges section
6. Return the created `Relationship`

**Output**: `*entities.Relationship`

---

### `ListRelationships`

**File**: `internal/core/usecases/list_relationships.go`

**Input**: `projectRoot`, `systemID`, optional `filterSource`, optional `filterTarget`

**Behaviour**: Load all relationships for system; filter if source/target filter provided; return slice.

**Output**: `[]entities.Relationship`

---

### `DeleteRelationship`

**File**: `internal/core/usecases/delete_relationship.go`

**Input**: `projectRoot`, `systemID`, `relationshipID`

**Behaviour**:
1. Load relationships
2. Find entry with matching ID — return `ErrNotFound` if absent
3. Remove entry and call `SaveRelationships`
4. Regenerate edges in affected diagram file

**Output**: error or nil

---

## Modified Entities/Use Cases

### `ValidateArchitecture` (modified)

**File**: `internal/core/usecases/validate_architecture.go`

**Change**: In `checkIsolatedComponents`, add early return guard:
```go
if graph.EdgeCount() == 0 {
    return // FR-012: suppress all isolation findings when no relationships exist
}
```
No new fields or types needed.

---

## Unchanged Entities (for reference)

The following existing entities are **not modified** by this feature:

- `System`, `Container`, `Component` — field set unchanged
- `D2Relationship` — still used for D2 parsing; not replaced (coexists with new `Relationship` entity)
- `ArchitectureGraph`, `GraphEdge`, `GraphNode` — unchanged; `BuildArchitectureGraph` will be extended to also load from `RelationshipRepository` (separate concern, covered in tasks)
- `ProjectRepository` port — no new methods; relationship storage is a separate port

---

## Directory / File Layout

```
src/
└── <system-id>/
    ├── system.md              # existing
    ├── system.d2              # existing — edges section regenerated on relationship write
    ├── relationships.toml     # NEW — created by SaveRelationships on first create_relationship
    └── <container-id>/
        ├── container.md       # existing
        ├── container.d2       # existing — edges appended for component relationships
        └── <component-id>/
            └── component.md  # existing — unchanged

internal/core/entities/
├── relationship.go            # NEW
└── [all existing files unchanged]

internal/core/usecases/
├── create_relationship.go     # NEW
├── list_relationships.go      # NEW
├── delete_relationship.go     # NEW
├── ports.go                   # MODIFY: add RelationshipRepository
└── validate_architecture.go   # MODIFY: FR-012 suppression

internal/adapters/filesystem/
└── relationship_repo.go       # NEW

internal/mcp/tools/
├── create_relationship.go     # NEW
├── list_relationships.go      # NEW
├── delete_relationship.go     # NEW
├── create_components.go       # NEW
├── create_container.go        # MODIFY: inject DiagramGenerator
├── helpers.go                 # MODIFY: add suggestSlugID + notFoundError
└── registry.go                # MODIFY: register new tools, wire DiagramGenerator
```
