# MCP Tool Contracts: Batch and UX Fixes

**Feature**: 008-mcp-ux-improvements  
**Date**: 2026-02-19

Contracts for `create_components` (batch), the `create_container` diagram init fix, and the error message slug suggestion behaviour.

---

## `create_components` (batch)

### Input Schema

```json
{
  "type": "object",
  "required": ["project_root", "system_name", "container_name", "components"],
  "properties": {
    "project_root": {
      "type": "string",
      "description": "Root directory of the loko project (default: '.')"
    },
    "system_name": {
      "type": "string",
      "description": "Parent system name"
    },
    "container_name": {
      "type": "string",
      "description": "Parent container name"
    },
    "components": {
      "type": "array",
      "minItems": 1,
      "description": "Array of component definitions to create",
      "items": {
        "type": "object",
        "required": ["name"],
        "properties": {
          "name": {
            "type": "string",
            "description": "Component name (e.g., 'Request Validator')"
          },
          "description": {
            "type": "string",
            "description": "What this component does"
          },
          "technology": {
            "type": "string",
            "description": "Technology/implementation detail (e.g., 'Go')"
          },
          "tags": {
            "type": "array",
            "items": { "type": "string" },
            "description": "Categorization tags"
          }
        }
      }
    }
  }
}
```

### Success Response (all created)

```json
{
  "created": 3,
  "failed": 0,
  "results": [
    { "id": "request-validator", "name": "Request Validator", "status": "created" },
    { "id": "rate-limiter",      "name": "Rate Limiter",      "status": "created" },
    { "id": "auth-handler",      "name": "Auth Handler",      "status": "created" }
  ]
}
```

### Partial Success Response (some failed)

```json
{
  "created": 2,
  "failed": 1,
  "results": [
    { "id": "request-validator", "name": "Request Validator", "status": "created" },
    { "name": "Rate Limiter",    "status": "error", "error": "component 'rate-limiter' already exists" },
    { "id": "auth-handler",      "name": "Auth Handler",      "status": "created" }
  ]
}
```

### Error Cases

| Condition | Behaviour |
|---|---|
| `components` is empty array | Return error: `"components array must have at least one item"` |
| `system_name` not found | Return error immediately (no partial processing) |
| `container_name` not found | Return error immediately (no partial processing) |
| Individual component name conflict | Record per-item error; continue processing remaining items |
| Individual component invalid name | Record per-item error; continue processing remaining items |

**Note**: System/container lookup failures abort the entire batch. Individual component failures do not abort the batch.

---

## `create_container` — Diagram Initialization Fix

### Changed Behaviour (FR-007, FR-008)

**Before**: Response always contained `"diagram": "Use 'update_diagram' tool to add D2 diagram"`

**After**: Response contains `"diagram": "D2 template created at src/<system>/<container>/container.d2"`

No change to input schema. This is a behaviour fix only.

### Updated Response Shape

```json
{
  "container": {
    "id": "api-lambda",
    "name": "API Lambda",
    "description": "Handles all inbound REST API requests",
    "technology": "Go + AWS Lambda",
    "tags": ["backend", "lambda"],
    "diagram": "D2 template created at src/agwe/api-lambda/container.d2"
  }
}
```

### Diagram File Generated

The scaffold file (`container.d2`) contains the container context diagram showing the new container within its system boundary. It is generated by the existing `DiagramGenerator.GenerateContainerDiagram()` method, which is now wired into `CreateContainerTool`.

---

## Error Message Slug Suggestions (FR-014, FR-015)

### Behaviour

When any MCP tool receives an element name that does not match a known ID, the error message includes the likely slugified form.

**Tool calls affected**: `create_relationship`, `delete_relationship`, `list_relationships`, `update_component`, `update_container`, `update_system`, `query_dependencies`, `query_related_components`

### Error Message Format

```
{entity_type} "{input}" not found — did you mean "{suggested_slug}"?
```

**Example**:
```
container "API Lambda" not found — did you mean "api-lambda"?
```

**Fallback** (when no slug match found):
```
container "XYZ Unknown" not found — run 'query_architecture' to see available element IDs
```

### `create_*` Response — ID Always Included (FR-015)

All create tool responses now always include the `id` field:

```json
{
  "system":    { "id": "agwe",          "name": "Agwe", ... },
  "container": { "id": "api-lambda",    "name": "API Lambda", ... },
  "component": { "id": "auth-handler",  "name": "Auth Handler", ... },
  "relationship": { "id": "a1b2c3d4",  ... }
}
```

The `id` field was already present in existing `create_component` and `create_container` responses. FR-015 ensures no create tool omits it.

---

## `validate` — Isolation Suppression (FR-012)

### Changed Behaviour

**Before**: Every component emitted an `isolated_component` info finding when no relationships existed.

**After**: When the project has zero relationships (empty or absent `relationships.toml`), no `isolated_component` findings are emitted at all.

### Example: Fresh project with 5 components, no relationships

**Before**:
```json
{
  "valid": true,
  "report": {
    "issues": [
      { "severity": "info", "code": "isolated_component", "title": "5 isolated component(s) found", ... }
    ],
    "infos": 1
  }
}
```

**After**:
```json
{
  "valid": true,
  "report": {
    "issues": [],
    "infos": 0,
    "summary": "Architecture is valid - no critical issues found"
  }
}
```

Once at least one relationship exists, isolated components are flagged normally for components genuinely not connected to anything.
