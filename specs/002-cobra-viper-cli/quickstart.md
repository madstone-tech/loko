# Quickstart: Cobra & Viper CLI Migration

**Branch**: `002-cobra-viper` | **Date**: 2026-02-05

---

## Prerequisites

- Go 1.25+
- Existing loko codebase on `main` branch

## Dependencies

```bash
go get github.com/spf13/cobra@v1.10.2
go get github.com/spf13/viper@v1.21.0
```

## Migration Overview

### What changes

| Component | Before | After |
|-----------|--------|-------|
| `main.go` | ~377 lines, switch/case dispatch | ~10 lines, calls `cmd.Execute()` |
| `cmd/*.go` | Builder pattern with `flag.FlagSet` | Cobra commands with `cobra.Command` |
| Config loading | `BurntSushi/toml` in `adapters/config/` | Viper in `adapters/config/` |
| Config path | `~/.loko/config.toml` | `~/.config/loko/config.toml` (XDG) |
| Shell completions | None | Built-in via Cobra |
| Help system | Manual `printUsage()` | Auto-generated by Cobra |

### What stays the same

- All command names and flag names (backward compatible)
- `cmd/` package builder pattern (`NewXxxCommand().WithYyy().Execute(ctx)`)
- Clean architecture: `core/` → `adapters/` → `cmd/`
- All 18 port interfaces (2 new ones added, none removed)
- Entity validation in `core/entities/`
- UI output via `internal/ui/`

## Key Patterns

### 1. Root command with config init

```go
// cmd/root.go
var rootCmd = &cobra.Command{
    Use:   "loko",
    Short: "Guardian of Architectural Wisdom",
    PersistentPreRunE: func(cmd *cobra.Command, args []string) error {
        return initConfig()
    },
}

func Execute() error {
    return rootCmd.Execute()
}
```

### 2. Subcommand registration

```go
// cmd/build.go
var buildCmd = &cobra.Command{
    Use:     "build",
    Short:   "Build documentation site",
    GroupID: "building",
    RunE:    runBuild,
}

func init() {
    rootCmd.AddCommand(buildCmd)
    buildCmd.Flags().BoolVar(&clean, "clean", false, "Rebuild everything")
    viper.BindPFlag("build.clean", buildCmd.Flags().Lookup("clean"))
}
```

### 3. Config hierarchy

```go
// cmd/root.go
func initConfig() error {
    viper.SetConfigType("toml")
    viper.SetDefault("d2.theme", "neutral-default")
    // ... more defaults

    // Global config (lowest priority file)
    viper.SetConfigFile(paths.ConfigFile())
    _ = viper.ReadInConfig()

    // Project config (overrides global)
    viper.SetConfigFile("loko.toml")
    _ = viper.MergeInConfig()

    // Env vars override config files
    viper.SetEnvPrefix("LOKO")
    viper.SetEnvKeyReplacer(strings.NewReplacer(".", "_"))
    viper.AutomaticEnv()

    return nil
}
```

## Testing

```bash
task test                          # Run all tests
go test -v ./internal/core/...     # Core only
go test -v ./cmd/...               # Command tests
go test -v ./internal/adapters/config/... # Config tests
```

## Verification

After migration, verify:
1. `loko --help` shows grouped commands
2. `loko build --help` shows flags with descriptions
3. `loko completion bash` outputs valid script
4. `loko buidl` suggests "Did you mean 'build'?"
5. `LOKO_D2_THEME=dark loko build` uses dark theme
6. `~/.config/loko/config.toml` is read on startup
