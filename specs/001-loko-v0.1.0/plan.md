# Implementation Plan: loko v0.1.0

**Branch**: `001-loko-v0.1.0` | **Date**: 2025-12-17 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/specs/001-loko-v0.1.0/spec.md`

**Note**: This plan is the execution roadmap for Phase 0 (Research) and Phase 1 (Design) of loko v0.1.0.

## Summary

**loko** is a C4 model architecture documentation tool enabling Cloud Solution Architects to design systems conversationally with LLM agents via MCP, while providing CLI and API interfaces for direct interaction.

**Primary Requirement**: Build a unified interface (MCP + CLI + API) for defining, validating, rendering, and exporting C4 architecture models with real-time file watching and token-efficient queries.

**Technical Approach**: Go 1.25 single-binary tool with clean architecture (core/ â†’ adapters â†’ CLI/MCP/API), composing specialized tools (d2 for diagrams, ason for templates) rather than reimplementing them. File-based storage with optional TOML configuration. Progressive context loading for LLM queries.

## Technical Context

**Language/Version**: Go 1.25+  
**Primary Dependencies**: Cobra (CLI), Viper (config), Lipgloss (formatting), Bubbletea (interactive prompts), ason (templates), MCP SDK (model context protocol)  
**Storage**: File system (src/ directory structure + loko.toml configuration); no database  
**Testing**: Go test (unit/integration/golden); no third-party mocking libraries; concrete mocks only  
**Target Platform**: Linux, macOS, Windows (single cross-platform binary)  
**Project Type**: Single Go project with CLI commands + MCP server + HTTP API  
**Performance Goals**: Build 100 diagrams in <30 seconds (NFR-001); watch mode rebuilds in <500ms (NFR-002); memory usage <100MB for 50 systems (NFR-003)  
**Constraints**: Architecture queries <500 tokens for 20-system overview (NFR-010); single-pass parsing; immutable builds (same input â†’ same output)  
**Scale/Scope**: Support 1000+ documents; 6 user stories (4 P1 + 2 P2); 8 implementation phases; 62 tasks

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

**Status**: âœ… PASS (No violations; all 8 core values and 5 architecture principles aligned)

| Principle | Check | Notes |
|-----------|-------|-------|
| **I. Simplicity** | âœ… | Single Go binary; zero external deps in core/; minimal config |
| **II. User Empowerment** | âœ… | MCP (LLM) + CLI (direct) + API (automation) equally supported |
| **III. Convention over Config** | âœ… | Smart defaults in loko.toml; templates; scaffolding commands |
| **IV. Composability** | âœ… | Shell to d2 (diagrams), ason (templates), veve-cli (PDF); no reimplementation |
| **V. Transparency** | âœ… | ADRs in docs/adr/; ROADMAP.md; open specifications in specs/ |
| **VI. Token Efficiency** | âœ… | Progressive loading; TOON format (30%+ reduction); query context budgets |
| **Clean Architecture** | âœ… | Strict core/ (no deps) â†’ adapters (infrastructure) â†’ CLI/MCP/API (thin wrappers <50 lines) |
| **Interfaces for Testability** | âœ… | All external deps via interfaces; concrete mocks in tests; no third-party mocking |
| **Error Handling** | âœ… | All errors wrapped with context; lipgloss formatting for user messages |
| **Structured Logging** | âœ… | JSON structured logging via slog; configurable log levels |
| **Test Coverage** | âœ… | >80% target for internal/core/; golden tests for output; contract tests for adapters |

## Project Structure

### Documentation (this feature)

```text
specs/001-loko-v0.1.0/
â”œâ”€â”€ plan.md              # â† This file (Phase 0-1 implementation roadmap)
â”œâ”€â”€ spec.md              # âœ… Complete feature specification (6 user stories, 24 FR, 11 NFR)
â”œâ”€â”€ research.md          # âœ… Phase 0 output: technology decisions, architecture rationale, risks
â”œâ”€â”€ data-model.md        # âœ… Phase 1 output: entity definitions with Go structs (5 entities)
â”œâ”€â”€ quickstart.md        # âœ… Phase 1 output: acceptance test scenarios, performance benchmarks
â”œâ”€â”€ contracts/
â”‚   â””â”€â”€ mcp-tools.md     # âœ… Phase 1 output: 8 MCP tools with JSON schemas, examples
â””â”€â”€ tasks.md             # Generated by .specify/memory/tasks.md (62 implementation tasks)
```

### Source Code (Option 1: Single Go Project - SELECTED)

```text
# Main repository
.
â”œâ”€â”€ main.go                      # CLI entrypoint
â”œâ”€â”€ go.mod, go.sum              # Go modules
â”œâ”€â”€ Makefile, Taskfile.yml       # Build automation
â”‚
â”œâ”€â”€ internal/
â”‚   â”œâ”€â”€ core/                    # Business logic (ZERO external deps)
â”‚   â”‚   â”œâ”€â”€ entities/            # Domain objects
â”‚   â”‚   â”‚   â”œâ”€â”€ project.go       # Project entity
â”‚   â”‚   â”‚   â”œâ”€â”€ system.go        # System entity
â”‚   â”‚   â”‚   â”œâ”€â”€ container.go     # Container entity
â”‚   â”‚   â”‚   â”œâ”€â”€ component.go     # Component entity
â”‚   â”‚   â”‚   â”œâ”€â”€ diagram.go       # Diagram entity
â”‚   â”‚   â”‚   â”œâ”€â”€ errors.go        # Domain-specific errors
â”‚   â”‚   â”‚   â”œâ”€â”€ validation.go    # Validation logic
â”‚   â”‚   â”‚   â”œâ”€â”€ template.go      # Template definitions
â”‚   â”‚   â”‚   â””â”€â”€ *_test.go        # Entity tests
â”‚   â”‚   â”œâ”€â”€ usecases/            # Application logic
â”‚   â”‚   â”‚   â”œâ”€â”€ project_init.go  # Initialize project
â”‚   â”‚   â”‚   â”œâ”€â”€ system_create.go # Create system
â”‚   â”‚   â”‚   â”œâ”€â”€ build.go         # Build documentation
â”‚   â”‚   â”‚   â”œâ”€â”€ validate.go      # Validate structure
â”‚   â”‚   â”‚   â”œâ”€â”€ query.go         # Query architecture (token-efficient)
â”‚   â”‚   â”‚   â”œâ”€â”€ export.go        # Export to formats
â”‚   â”‚   â”‚   â”œâ”€â”€ ports.go         # Adapter interfaces
â”‚   â”‚   â”‚   â””â”€â”€ *_test.go        # Usecase tests
â”‚   â”‚   â””â”€â”€ *_test.go            # Core integration tests
â”‚   â”‚
â”‚   â”œâ”€â”€ adapters/                # Infrastructure implementations
â”‚   â”‚   â”œâ”€â”€ filesystem/          # File I/O
â”‚   â”‚   â”‚   â”œâ”€â”€ project_repo.go  # Project repository
â”‚   â”‚   â”‚   â”œâ”€â”€ system_repo.go   # System repository
â”‚   â”‚   â”‚   â”œâ”€â”€ watch.go         # File watcher (fsnotify)
â”‚   â”‚   â”‚   â””â”€â”€ *_test.go
â”‚   â”‚   â”œâ”€â”€ d2/                  # D2 integration (shell out)
â”‚   â”‚   â”‚   â”œâ”€â”€ renderer.go      # Calls d2 CLI
â”‚   â”‚   â”‚   â””â”€â”€ *_test.go
â”‚   â”‚   â”œâ”€â”€ encoding/            # Serialization
â”‚   â”‚   â”‚   â”œâ”€â”€ toon.go          # TOON format (token-efficient)
â”‚   â”‚   â”‚   â”œâ”€â”€ markdown.go      # Markdown output
â”‚   â”‚   â”‚   â””â”€â”€ *_test.go
â”‚   â”‚   â”œâ”€â”€ html/                # HTML generation
â”‚   â”‚   â”‚   â”œâ”€â”€ builder.go       # HTML generation
â”‚   â”‚   â”‚   â”œâ”€â”€ templates/       # Embedded templates
â”‚   â”‚   â”‚   â””â”€â”€ *_test.go
â”‚   â”‚   â”œâ”€â”€ config/              # Config management (Viper)
â”‚   â”‚   â”‚   â”œâ”€â”€ loader.go        # Load loko.toml
â”‚   â”‚   â”‚   â””â”€â”€ *_test.go
â”‚   â”‚   â””â”€â”€ logging/             # Structured logging
â”‚   â”‚       â”œâ”€â”€ logger.go        # slog wrapper
â”‚   â”‚       â””â”€â”€ *_test.go
â”‚   â”‚
â”‚   â”œâ”€â”€ cli/                     # CLI commands (Cobra) - thin wrappers
â”‚   â”‚   â”œâ”€â”€ root.go              # Root command
â”‚   â”‚   â”œâ”€â”€ init.go              # loko init
â”‚   â”‚   â”œâ”€â”€ new.go               # loko new (system/container)
â”‚   â”‚   â”œâ”€â”€ build.go             # loko build
â”‚   â”‚   â”œâ”€â”€ watch.go             # loko watch
â”‚   â”‚   â”œâ”€â”€ serve.go             # loko serve
â”‚   â”‚   â”œâ”€â”€ validate.go          # loko validate
â”‚   â”‚   â””â”€â”€ *_test.go
â”‚   â”‚
â”‚   â”œâ”€â”€ mcp/                     # MCP server (thin wrappers)
â”‚   â”‚   â”œâ”€â”€ server.go            # MCP server setup
â”‚   â”‚   â”œâ”€â”€ tools.go             # MCP tool handlers (8 tools)
â”‚   â”‚   â””â”€â”€ *_test.go
â”‚   â”‚
â”‚   â””â”€â”€ api/                     # HTTP API (thin wrappers)
â”‚       â”œâ”€â”€ routes.go            # API routes
â”‚       â”œâ”€â”€ handlers.go          # Request handlers
â”‚       â””â”€â”€ *_test.go
â”‚
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ integration/             # Integration tests
â”‚   â”‚   â”œâ”€â”€ end_to_end_test.go  # CLI â†’ project â†’ output
â”‚   â”‚   â”œâ”€â”€ mcp_integration_test.go
â”‚   â”‚   â””â”€â”€ api_integration_test.go
â”‚   â””â”€â”€ golden/                  # Golden tests (output validation)
â”‚       â”œâ”€â”€ testdata/            # Expected outputs
â”‚       â””â”€â”€ golden_test.go       # Golden test runner
â”‚
â”œâ”€â”€ docs/
â”‚   â”œâ”€â”€ adr/                     # Architecture Decision Records
â”‚   â”‚   â”œâ”€â”€ 0001-clean-architecture.md
â”‚   â”‚   â”œâ”€â”€ 0002-token-efficient-mcp.md
â”‚   â”‚   â”œâ”€â”€ 0003-toon-format.md
â”‚   â”‚   â””â”€â”€ template.md
â”‚   â””â”€â”€ DEPLOYMENT.md            # Deployment guide
â”‚
â”œâ”€â”€ .specify/                    # Specification & planning
â”‚   â”œâ”€â”€ memory/
â”‚   â”‚   â”œâ”€â”€ constitution.md      # Governance (v1.0.0)
â”‚   â”‚   â”œâ”€â”€ spec.md              # Feature spec
â”‚   â”‚   â”œâ”€â”€ plan.md              # (Reference only)
â”‚   â”‚   â””â”€â”€ tasks.md             # 62 implementation tasks
â”‚   â”œâ”€â”€ checklists/
â”‚   â”‚   â””â”€â”€ specification.md     # 125 requirement checks
â”‚   â”œâ”€â”€ scripts/
â”‚   â”‚   â””â”€â”€ bash/
â”‚   â”‚       â”œâ”€â”€ check-prerequisites.sh
â”‚   â”‚       â”œâ”€â”€ setup-plan.sh
â”‚   â”‚       â””â”€â”€ update-agent-context.sh
â”‚   â””â”€â”€ templates/
â”‚       â”œâ”€â”€ plan-template.md
â”‚       â”œâ”€â”€ spec-template.md
â”‚       â””â”€â”€ tasks-template.md
â”‚
â””â”€â”€ specs/
    â”œâ”€â”€ 001-loko-v0.1.0/        # This feature
    â”‚   â”œâ”€â”€ spec.md
    â”‚   â”œâ”€â”€ plan.md             # â† You are here
    â”‚   â”œâ”€â”€ research.md
    â”‚   â”œâ”€â”€ data-model.md
    â”‚   â”œâ”€â”€ quickstart.md
    â”‚   â”œâ”€â”€ contracts/
    â”‚   â”‚   â””â”€â”€ mcp-tools.md
    â”‚   â””â”€â”€ tasks.md
    â””â”€â”€ README.md               # Navigation guide
```

**Structure Decision**: Selected **Option 1: Single Go Project**. 
- Rationale: loko is a single cohesive tool (not frontend/backend split); all code shares core/ abstractions; single binary deployment simplifies distribution
- All business logic isolated in internal/core/ (zero external deps); infrastructure in adapters/; thin CLI/MCP/API wrappers <50 lines each
- File system as database (src/ directories); optional TOML config via Viper
- Tests co-located with source (*_test.go); integration & golden tests in tests/

## Complexity Tracking

> **Empty**: No Constitution violations; all design decisions aligned with governance

(No entries - all principles met without exception)

## Definition of Done (Phase 0-1)

**Phase 0 (Research)** - COMPLETE âœ…
- âœ… Constitution v1.0.0 created and ratified
- âœ… Research completed: technology stack, architecture rationale, risks documented in research.md
- âœ… ADRs created for key decisions (ADR-0001 to ADR-0003)
- âœ… Constitution Check gate passed (no violations)

**Phase 1 (Design)** - COMPLETE âœ…
- âœ… Data model defined: 5 entities (Project, System, Container, Component, Diagram) with Go struct definitions and validation rules
- âœ… Entity file formats specified: project.md, system.md, component.md, diagram.d2, loko.toml
- âœ… MCP tools API contracted: 8 tools with JSON input/output schemas, error handling, examples
- âœ… Acceptance test scenarios written for all 6 user stories with expected outcomes
- âœ… Performance benchmarks defined (build 100 diagrams in <30s, watch <500ms, memory <100MB)
- âœ… Project structure finalized (single Go project layout with clean architecture boundaries)
- âœ… Test strategy documented (unit >80%, integration E2E, golden output validation, no third-party mocks)

**Phase 0-1 Handoff** - IN PROGRESS ğŸ”„
- ğŸ”„ Complete plan.md with Technical Context (THIS TASK)
- ğŸ”„ Run Constitution Check gate verification (NEXT)
- ğŸ”„ Update agent context files (NEXT)
- ğŸ”„ Generate final Phase 0-1 report (NEXT)
