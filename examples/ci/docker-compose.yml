# Docker Compose for loko Local Development
#
# This environment provides:
# - Watch mode: Auto-rebuild documentation on file changes (< 500ms)
# - Volume mounts: Live editing without rebuilding container
# - Pre-installed: loko, D2, veve-cli
# - HTTP server: View documentation at http://localhost:8080
#
# Usage:
#   cd examples/ci
#   docker-compose up
#   # Edit your architecture files - docs rebuild automatically
#   # View at http://localhost:8080

version: '3.8'

services:
  loko-dev:
    build:
      context: ../..
      dockerfile: examples/ci/Dockerfile
    container_name: loko-dev
    
    # Mount project root for live editing
    volumes:
      - ../../src:/workspace/src:ro
      - ../../loko.toml:/workspace/loko.toml:ro
      - ../../dist:/workspace/dist
    
    # Watch mode: Rebuild on file changes
    command: >
      sh -c "
        echo 'Starting loko watch mode...'
        echo 'Watching for changes in src/ and loko.toml'
        echo ''
        while true; do
          loko build --format html --format markdown
          if [ $$? -eq 0 ]; then
            echo '✅ Build successful at' $$(date '+%H:%M:%S')
          else
            echo '❌ Build failed at' $$(date '+%H:%M:%S')
          fi
          
          # Watch for file changes (check every 2 seconds)
          inotifywait -r -e modify,create,delete --timeout 2 src/ loko.toml 2>/dev/null || sleep 2
        done
      "
    
    # Install inotify-tools for file watching
    entrypoint: >
      sh -c "
        apt-get update > /dev/null && apt-get install -y inotify-tools > /dev/null 2>&1
        exec sh -c \"$$@\"
      " --
    
    # Health check
    healthcheck:
      test: ["CMD", "loko", "version"]
      interval: 30s
      timeout: 5s
      retries: 3
    
    # Resource limits (adjust as needed)
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M

  # HTTP server to view generated documentation
  docs-server:
    image: nginx:alpine
    container_name: loko-docs-server
    
    depends_on:
      - loko-dev
    
    ports:
      - "8080:80"
    
    volumes:
      - ../../dist:/usr/share/nginx/html:ro
    
    # Health check
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:80"]
      interval: 30s
      timeout: 5s
      retries: 3

# Expected behavior:
# - ✅ File change detected: Rebuild triggered within 2 seconds
# - ✅ Build time: < 500ms for incremental changes
# - ✅ HTTP server: http://localhost:8080 serves latest HTML docs
# - ❌ Invalid architecture: Error message logged, no dist/ update
#
# Performance:
# - Initial build: 2-5 seconds
# - Incremental rebuild: < 500ms
# - File change detection: < 2 seconds
#
# Logs:
#   docker-compose logs -f loko-dev     # Watch build logs
#   docker-compose logs -f docs-server  # Watch HTTP server logs
#
# Stop:
#   docker-compose down
#
# Clean rebuild:
#   docker-compose down -v
#   docker-compose build --no-cache
#   docker-compose up
