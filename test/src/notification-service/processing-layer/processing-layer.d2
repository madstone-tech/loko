direction: down

title: {
  label: Processing Layer - Component Diagram
  near: top-center
  shape: text
  style.font-size: 20
  style.bold: true
}

# Entry points (external)
api-gw: API Gateway {
  shape: rectangle
  style.fill: "#999999"
  style.font-color: "#ffffff"
}

event-bus: EventBridge {
  shape: rectangle
  style.fill: "#999999"
  style.font-color: "#ffffff"
}

# Lambda Functions
notification-router: Notification Router {
  shape: rectangle
  style.fill: "#438DD5"
  style.font-color: "#ffffff"
  label: |md
    **Notification Router**
    Validates, generates ID,
    writes DynamoDB, enqueues SQS
  |
}

email-sender: Email Sender {
  shape: rectangle
  style.fill: "#438DD5"
  style.font-color: "#ffffff"
  label: |md
    **Email Sender**
    Formats & sends via SES,
    updates delivery status
  |
}

sms-sender: SMS Sender {
  shape: rectangle
  style.fill: "#438DD5"
  style.font-color: "#ffffff"
  label: |md
    **SMS Sender**
    Formats & sends via SNS,
    updates delivery status
  |
}

status-tracker: Status Tracker {
  shape: rectangle
  style.fill: "#438DD5"
  style.font-color: "#ffffff"
  label: |md
    **Status Tracker**
    Processes delivery callbacks,
    updates DynamoDB
  |
}

retry-handler: Retry Handler {
  shape: rectangle
  style.fill: "#438DD5"
  style.font-color: "#ffffff"
  label: |md
    **Retry Handler**
    Exponential backoff retries,
    max 3 attempts
  |
}

# External dependencies
email-queue: Email Queue (SQS) {
  shape: queue
  style.fill: "#999999"
  style.font-color: "#ffffff"
}

sms-queue: SMS Queue (SQS) {
  shape: queue
  style.fill: "#999999"
  style.font-color: "#ffffff"
}

dlq: Dead Letter Queue {
  shape: queue
  style.fill: "#999999"
  style.font-color: "#ffffff"
}

dynamo: DynamoDB {
  shape: cylinder
  style.fill: "#999999"
  style.font-color: "#ffffff"
}

ses: Amazon SES {
  shape: rectangle
  style.fill: "#999999"
  style.font-color: "#ffffff"
}

sns: Amazon SNS {
  shape: rectangle
  style.fill: "#999999"
  style.font-color: "#ffffff"
}

# Flows
api-gw -> notification-router: "POST /notifications"
event-bus -> notification-router: "Matched events"

notification-router -> dynamo: "Write PENDING"
notification-router -> email-queue: "Enqueue email"
notification-router -> sms-queue: "Enqueue SMS"

email-queue -> email-sender: "Consume (batch 5)"
sms-queue -> sms-sender: "Consume (batch 5)"

email-sender -> ses: "SendEmail"
email-sender -> dynamo: "Update status"

sms-sender -> sns: "Publish SMS"
sms-sender -> dynamo: "Update status"

ses -> status-tracker: "Delivery callbacks"
status-tracker -> dynamo: "Update final status"

email-queue -> dlq: "After 3 failures"
sms-queue -> dlq: "After 3 failures"

dlq -> retry-handler: "Consume (batch 1)"
retry-handler -> email-queue: "Re-enqueue email"
retry-handler -> sms-queue: "Re-enqueue SMS"
retry-handler -> dynamo: "Mark PERMANENTLY_FAILED"
